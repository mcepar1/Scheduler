# -*- coding: utf-8 -*-

import wx
import wx.grid
import wx.calendar
import wx_extensions

import datetime

from global_vars import turnuses, holidays

class PersonPanel(wx.Panel):

  # if no person is selected
  INVALID_LABEL = "Izberite osebo za urejanje."

  def __init__(self, *args, **kwargs):
    wx.Panel.__init__(self, *args, **kwargs)
    
    self.person = None
    
    sizer = wx.BoxSizer(wx.VERTICAL)
    
    self.person_info = wx.StaticText(self,wx.NewId(),PersonPanel.INVALID_LABEL)
    sizer.Add(self.person_info,0,wx.CENTER)
    
    self.calendar = wx.calendar.CalendarCtrl(self, wx.NewId(), style = wx.calendar.CAL_MONDAY_FIRST | wx.calendar.CAL_SHOW_HOLIDAYS | wx.calendar.CAL_SEQUENTIAL_MONTH_SELECTION)
    self.Bind(wx.calendar.EVT_CALENDAR_SEL_CHANGED, self.__update_date, self.calendar)
    sizer.Add(self.calendar,1,wx.CENTER | wx.EXPAND)
    
    self.permissions = PermissionsPanel(self)
    sizer.Add(self.permissions,0, wx.ALIGN_LEFT)
    
    self.SetSizerAndFit(sizer)
    
  def set_person(self,person):
    """Sets the person, that is represnted by this panel.
      person: the person, that is represented
    """
    if person:
      self.person_info.SetLabel(str(person))
      self.permissions.set_unit(person, self.__get_date())
    else:
      self.person_info.SetLabel(PersonPanel.INVALID_LABEL)
      self.permissions.set_unit(person, self.__get_date())
      
    self.person = person
      
  def __update_date(self,event):
    """Event listener of the calendar object"""
    self.permissions.set_unit(self.person, self.__get_date())
    
  def __get_date(self):
    """Reads the date from the calendar control and returns a python date object.
      return: a python date, as selected in the calendar control.
    """
    # month is zero-based
    # TODO: there has to be a better way to convert the date
    # print self.calendar.GetDate().GetDay(), self.calendar.GetDate().GetMonth(), self.calendar.GetDate().GetYear()
    return datetime.date(day = self.calendar.GetDate().GetDay(), month = self.calendar.GetDate().GetMonth() + 1, year = self.calendar.GetDate().GetYear())
    
class PermissionsPanel(wx.Panel):
  def __init__(self, *args, **kwargs):
    wx.Panel.__init__(self, *args, **kwargs)
    
    self.person = None
    self.date = None
    
    topSizer = wx.BoxSizer(wx.HORIZONTAL)
    
    turnusSizer = wx.StaticBoxSizer(wx.StaticBox(self,wx.NewId(),"Turnusi"),wx.VERTICAL)
    holidaySizer = wx.StaticBoxSizer(wx.StaticBox(self,wx.NewId(),"Dopusti"), wx.VERTICAL)
    
    #set the turnuses
    self.turnuses = []
    for turnus in turnuses.turnuses:
      self.turnuses.append(wx_extensions.LinkedCheckBox(turnus,self,wx.NewId(),str(turnus)))
      self.Bind(wx.EVT_CHECKBOX, self.__turnus_edited, self.turnuses[-1])
      turnusSizer.Add(self.turnuses[-1],0,wx.ALIGN_LEFT)
    

    #set the holidays
    self.holidays = []
    for holiday in holidays.holidays:
      self.holidays.append(wx_extensions.LinkedCheckBox(holiday,self,wx.NewId(),str(holiday)))
      self.Bind(wx.EVT_CHECKBOX, self.__holiday_edited, self.holidays[-1])
      holidaySizer.Add(self.holidays[-1],0,wx.ALIGN_LEFT)
    
    #set the initial permissions  
    self.__set_permissions()
    
    topSizer.Add(turnusSizer,0,wx.ALIGN_RIGHT)
    topSizer.Add(holidaySizer,0,wx.ALIGN_RIGHT)
    
    self.SetSizerAndFit(topSizer)
    
  def set_unit(self, person, date):
    """
    Permissions are always edited on a person + date basis.
    This method sets the person and date.
      person: is the person, that will have their permission changed
      date: is the date for which the permissions apply
    """
    
    # either both are valid or both are invalid
    # it would work otherwise, but this keeps the internal state consistent
    if person and date:
      self.person = person
      self.date = date
    else:
      self.person = None
      self.date = None
    
    self.__set_permissions()
    
  def __turnus_edited(self,event):
    """The event listener for the turnus checkboxes."""
    if event.IsChecked():
      # remove the turnus from restrictions
      self.person.remove_invalid_turnus(self.date,event.GetEventObject().element)
    else:
      # add the restriction
      self.person.add_invalid_turnus(self.date,event.GetEventObject().element)
      
    # reload permissions - holiday to turnus sync
    self.__set_permissions()
    
  def __holiday_edited(self,event):
    """The event listener for the holiday checkboxes."""
    if event.IsChecked():
      # remove the turnus from restrictions
      self.person.add_holiday(self.date,event.GetEventObject().element)
    else:
      # add the restriction
      self.person.remove_holiday(self.date,event.GetEventObject().element)
      
    # reload permissions - holiday to turnus sync
    self.__set_permissions()
    
  def __set_permissions(self):
    """This method set's the initial permissions, according to the person and date attributes."""
    
    # edititing should not be possible
    if self.person == None or self.date == None:
      for turnus_checker in self.turnuses:
        turnus_checker.Disable()
      for holiday_checker in self.holidays:
        holiday_checker.Disable()
    else:
      for turnus_checker in self.turnuses:
        turnus_checker.Enable()
      for holiday_checker in self.holidays:
        holiday_checker.Enable()
        
      # select correct turnus permissons
      if self.date in self.person.forbidden_turnuses:
        turnuses = self.person.forbidden_turnuses[self.date]
        for turnus_checker in self.turnuses:
          if turnus_checker.element in turnuses:
            turnus_checker.SetValue(False)
          else:
            turnus_checker.SetValue(True)
      else:
        for turnus_checker in self.turnuses:
          turnus_checker.SetValue(True)
      
      # set the correct holiday permissions    
      if self.date in self.person.holidays:
        holidays = self.person.holidays[self.date]
        for holiday_checker in self.holidays:
          if holiday_checker.element in holidays:
            holiday_checker.SetValue(True)
          else:
            holiday_checker.SetValue(False)
      else:
        for holiday_checker in self.holidays:
          holiday_checker.SetValue(False)
      
    
